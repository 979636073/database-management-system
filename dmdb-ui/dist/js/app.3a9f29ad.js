(function(e){function t(t){for(var a,l,o=t[0],r=t[1],c=t[2],d=0,u=[];d<o.length;d++)l=o[d],Object.prototype.hasOwnProperty.call(s,l)&&s[l]&&u.push(s[l][0]),s[l]=0;for(a in r)Object.prototype.hasOwnProperty.call(r,a)&&(e[a]=r[a]);h&&h(t);while(u.length)u.shift()();return n.push.apply(n,c||[]),i()}function i(){for(var e,t=0;t<n.length;t++){for(var i=n[t],a=!0,l=1;l<i.length;l++){var r=i[l];0!==s[r]&&(a=!1)}a&&(n.splice(t--,1),e=o(o.s=i[0]))}return e}var a={},s={app:0},n=[];function l(e){return o.p+"js/"+({}[e]||e)+"."+{"chunk-2d0a3196":"cae3356c","chunk-2d0a3577":"135402b6","chunk-2d0a40c8":"6a3e9e1e","chunk-2d0a43df":"5aa4b030","chunk-2d0a4bbf":"37afb69c","chunk-2d0aa90c":"13ae6ed6","chunk-2d0aab07":"972cf50b","chunk-2d0abc00":"173158c8","chunk-2d0ae937":"75243ab7","chunk-2d0aeb45":"16c0d10f","chunk-2d0af08c":"ec6c1ad6","chunk-2d0afa49":"318bd625","chunk-2d0b1fd5":"e414b2f6","chunk-2d0b21d7":"0fc13758","chunk-2d0b2762":"06153f28","chunk-2d0b2b36":"972567bb","chunk-2d0b6187":"40715126","chunk-2d0ba136":"c75ee325","chunk-2d0bb267":"e5213e5c","chunk-2d0bcec1":"d384d870","chunk-2d0bdf38":"19a28172","chunk-2d0bff92":"000ea74d","chunk-2d0c0494":"231af084","chunk-2d0c0a09":"a3c1dd58","chunk-2d0c1ed0":"fcd41b09","chunk-2d0c4313":"3f6e453d","chunk-2d0c46d1":"bb2d136a","chunk-2d0c4a95":"20349cc3","chunk-2d0c512b":"e321c05b","chunk-2d0c86e3":"34ce6699","chunk-2d0c8f4c":"ca49839e","chunk-2d0cf16e":"9da0a6bc","chunk-2d0d056d":"a5a0a82c","chunk-2d0d0645":"e86ccf91","chunk-2d0d2f22":"0fbbd320","chunk-2d0d61fd":"d99537f6","chunk-2d0d7e63":"f89ffb97","chunk-2d0dda4e":"d7d4e08e","chunk-2d0de971":"5e1bbbde","chunk-2d0e1b57":"c5c39dab","chunk-2d0e1fbe":"d02695c5","chunk-2d0e22d6":"848cb40c","chunk-2d0e4fe5":"82039fdc","chunk-2d0e542a":"2c165ee5","chunk-2d0e57ec":"e304da16","chunk-2d0e5b34":"a8f880f4","chunk-2d0e6553":"36a75e6e","chunk-2d0e6c86":"a39eb1f0","chunk-2d0ea098":"fc7317d8","chunk-2d0f0a11":"cda3776e","chunk-2d208ac5":"a6f40b5e","chunk-2d208bdf":"1cf1a567","chunk-2d209408":"d1bce6ee","chunk-2d20eff5":"ac5980bd","chunk-2d20f745":"4efa787f","chunk-2d20ff23":"75d613b7","chunk-2d2138c7":"4c6d5593","chunk-2d216f3b":"75a4b2fd","chunk-2d217e5b":"f37ab6cf","chunk-2d21ab79":"cbbc9dca","chunk-2d21b84a":"55ac2248","chunk-2d21dcd2":"5baf63b4","chunk-2d21f327":"50f9b313","chunk-2d2214b3":"3a0f80af","chunk-2d221799":"6885d58c","chunk-2d221814":"1c0a256a","chunk-2d221a34":"4e1859c8","chunk-2d22502a":"7ba7f08e","chunk-2d226775":"f8e68f93","chunk-2d228ca6":"9af67802","chunk-2d229411":"bbf7b59a","chunk-2d2295e9":"b0158fb4","chunk-2d22c171":"3f24265d","chunk-2d22c2b8":"bd3aa6a0","chunk-2d22ca58":"2f892522","chunk-2d2311f7":"05a2fa86","chunk-2d2371be":"cf1a7104","chunk-2d237ee7":"1f3448fb","chunk-2d238465":"f46525c2","chunk-7532b3ea":"f2c3fdff"}[e]+".js"}function o(t){if(a[t])return a[t].exports;var i=a[t]={i:t,l:!1,exports:{}};return e[t].call(i.exports,i,i.exports,o),i.l=!0,i.exports}o.e=function(e){var t=[],i=s[e];if(0!==i)if(i)t.push(i[2]);else{var a=new Promise((function(t,a){i=s[e]=[t,a]}));t.push(i[2]=a);var n,r=document.createElement("script");r.charset="utf-8",r.timeout=120,o.nc&&r.setAttribute("nonce",o.nc),r.src=l(e);var c=new Error;n=function(t){r.onerror=r.onload=null,clearTimeout(d);var i=s[e];if(0!==i){if(i){var a=t&&("load"===t.type?"missing":t.type),n=t&&t.target&&t.target.src;c.message="Loading chunk "+e+" failed.\n("+a+": "+n+")",c.name="ChunkLoadError",c.type=a,c.request=n,i[1](c)}s[e]=void 0}};var d=setTimeout((function(){n({type:"timeout",target:r})}),12e4);r.onerror=r.onload=n,document.head.appendChild(r)}return Promise.all(t)},o.m=e,o.c=a,o.d=function(e,t,i){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},o.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&"object"===typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(o.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)o.d(i,a,function(t){return e[t]}.bind(null,a));return i},o.n=function(e){var t=e&&e.__esModule?function(){return e["default"]}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="/",o.oe=function(e){throw console.error(e),e};var r=window["webpackJsonp"]=window["webpackJsonp"]||[],c=r.push.bind(r);r.push=t,r=r.slice();for(var d=0;d<r.length;d++)t(r[d]);var h=c;n.push([0,"chunk-vendors"]),i()})({0:function(e,t,i){e.exports=i("56d7")},"18ce":function(e,t,i){},"3dd0":function(e,t,i){"use strict";i("18ce")},"56d7":function(e,t,i){"use strict";i.r(t);var a=i("2b0e"),s=i("5c96"),n=i.n(s),l=(i("0fae"),function(){var e=this,t=e._self._c;return t("div",{attrs:{id:"app"}},[t("MultiWindowLayout")],1)}),o=[],r=(i("e9f5"),i("910d"),function(){var e=this,t=e._self._c;return t("el-container",{staticClass:"layout-container"},[t("el-aside",{staticClass:"sidebar",attrs:{width:"280px"}},[t("div",{staticClass:"sidebar-header-wrapper"},[t("div",{staticClass:"sidebar-header-top"},[t("span",{staticClass:"app-title"},[t("i",{staticClass:"el-icon-coin"}),e._v(" 数据库列表")]),t("div",{staticClass:"header-actions"},[t("el-button",{staticStyle:{"margin-right":"8px","font-size":"16px"},attrs:{type:"text",icon:"el-icon-refresh",title:"刷新列表",loading:e.isRefreshing},on:{click:e.handleRefresh}}),t("el-button",{staticStyle:{"font-size":"16px"},attrs:{type:"text",icon:"el-icon-circle-plus-outline",title:"新建连接"},on:{click:e.openAddDialog}})],1)]),t("div",{staticClass:"sidebar-search"},[t("el-input",{attrs:{placeholder:"过滤库/表/视图...",size:"mini",clearable:"","prefix-icon":"el-icon-search"},model:{value:e.filterText,callback:function(t){e.filterText=t},expression:"filterText"}})],1)]),t("el-tree",{ref:"tree",staticClass:"db-tree",attrs:{data:e.treeData,props:e.defaultProps,load:e.loadNode,lazy:"","node-key":"id","highlight-current":"","filter-node-method":e.filterNode,"expand-on-click-node":!1},on:{"node-click":e.handleNodeClick},scopedSlots:e._u([{key:"default",fn:function({node:i,data:a}){return t("span",{staticClass:"custom-tree-node"},[t("span",{staticClass:"node-label"},[t("i",{class:e.getIcon(a.type),style:{color:"fail"===a.connStatus?"#F56C6C":""}}),e._v(" "+e._s(i.label)+" "),a.loading?t("i",{staticClass:"el-icon-loading",staticStyle:{"margin-left":"5px"}}):e._e(),"root"===a.type&&"fail"===a.connStatus?t("el-tooltip",{staticClass:"item",attrs:{effect:"dark",content:a.errorMsg||"连接失败",placement:"top"}},[t("span",{staticStyle:{color:"#f56c6c","font-size":"12px","margin-left":"5px",cursor:"pointer","font-weight":"bold"}},[t("i",{staticClass:"el-icon-warning-outline"}),e._v(" (离线) ")])]):e._e(),a.comment?t("span",{staticStyle:{color:"#999","font-size":"12px","margin-left":"5px"}},[e._v(e._s(a.comment))]):e._e(),"trigger"===a.type?t("span",{style:{color:"ENABLED"===a.status?"#67C23A":"#909399",fontSize:"12px",marginLeft:"5px",fontWeight:"bold"}},[e._v(" "+e._s("ENABLED"===a.status?"●":"○")+" ")]):e._e()],1),t("span",{staticClass:"node-actions"},["root"===a.type?[t("el-button",{attrs:{type:"text",icon:"el-icon-edit",size:"mini"},on:{click:function(t){return t.stopPropagation(),e.openEditDialog(a)}}}),t("el-button",{attrs:{type:"text",icon:"el-icon-delete",size:"mini"},on:{click:function(t){return t.stopPropagation(),e.handleDeleteConn(i,a)}}})]:e._e(),a.type&&a.type.startsWith("folder_")?[t("el-button",{attrs:{type:"text",icon:"el-icon-plus",size:"mini",title:"新建"},on:{click:function(t){return t.stopPropagation(),e.openCreateDialog(i,a)}}})]:e._e(),["table","view","trigger"].includes(a.type)?[t("el-button",{staticStyle:{color:"#f56c6c"},attrs:{type:"text",icon:"el-icon-delete",size:"mini",title:"删除"},on:{click:function(t){return t.stopPropagation(),e.handleDeleteObject(i,a)}}})]:e._e()],2)])}}])})],1),t("el-main",{staticClass:"main-content"},[0===e.tabs.length?t("div",{staticClass:"empty-state"},[t("i",{staticClass:"el-icon-monitor"}),t("p",[e._v("请新建连接并选择数据表或视图")])]):t("el-tabs",{staticClass:"content-tabs",attrs:{type:"card",closable:""},on:{"tab-remove":e.removeTab},model:{value:e.activeTab,callback:function(t){e.activeTab=t},expression:"activeTab"}},e._l(e.tabs,(function(i){return t("el-tab-pane",{key:i.key,attrs:{label:i.title,name:i.key}},[t("TableDetail",{attrs:{"conn-id":i.connId,"conn-name":i.connName,schema:i.schema,"table-name":i.tableName,"table-type":i.tableType,"initial-filter":i.filter,"init-view-mode":i.initViewMode},on:{"view-mode-change":e.handleViewModeChange,"open-table":e.handleOpenTable}})],1)})),1)],1),t("el-dialog",{attrs:{title:e.dialogTitle,visible:e.dialogVisible,width:"400px","close-on-click-modal":!1},on:{"update:visible":function(t){e.dialogVisible=t}}},[t("el-form",{attrs:{model:e.connForm,"label-width":"80px",size:"small"}},[t("el-form-item",{attrs:{label:"名称",required:""}},[t("el-input",{attrs:{placeholder:"连接名称 (唯一)"},model:{value:e.connForm.name,callback:function(t){e.$set(e.connForm,"name",t)},expression:"connForm.name"}})],1),t("el-form-item",{attrs:{label:"主机",required:""}},[t("el-input",{model:{value:e.connForm.host,callback:function(t){e.$set(e.connForm,"host",t)},expression:"connForm.host"}})],1),t("el-form-item",{attrs:{label:"端口",required:""}},[t("el-input",{model:{value:e.connForm.port,callback:function(t){e.$set(e.connForm,"port",t)},expression:"connForm.port"}})],1),t("el-form-item",{attrs:{label:"用户",required:""}},[t("el-input",{model:{value:e.connForm.user,callback:function(t){e.$set(e.connForm,"user",t)},expression:"connForm.user"}})],1),t("el-form-item",{attrs:{label:"密码"}},[t("el-input",{attrs:{type:"password"},model:{value:e.connForm.password,callback:function(t){e.$set(e.connForm,"password",t)},expression:"connForm.password"}})],1)],1),t("div",{attrs:{slot:"footer"},slot:"footer"},[t("el-button",{on:{click:function(t){e.dialogVisible=!1}}},[e._v("取消")]),t("el-button",{attrs:{type:"success",plain:"",loading:e.testing},on:{click:e.testConnection}},[e._v("测试连接")]),t("el-button",{attrs:{type:"primary",loading:e.connecting},on:{click:e.submitConnection}},[e._v("保存并连接")])],1)],1),t("el-dialog",{attrs:{title:"新建数据表",visible:e.createTableVisible,width:"700px","close-on-click-modal":!1},on:{"update:visible":function(t){e.createTableVisible=t}}},[t("el-form",{attrs:{model:e.tableForm,size:"small","label-width":"80px"}},[t("el-form-item",{attrs:{label:"表名",required:""}},[t("el-input",{staticStyle:{width:"100%"},attrs:{placeholder:"例如: USER_INFO"},model:{value:e.tableForm.tableName,callback:function(t){e.$set(e.tableForm,"tableName",t)},expression:"tableForm.tableName"}})],1),t("div",{staticStyle:{"margin-bottom":"10px","font-weight":"bold","border-bottom":"1px solid #eee","padding-bottom":"5px"}},[e._v(" 列定义 "),t("el-button",{staticStyle:{float:"right"},attrs:{type:"text",icon:"el-icon-plus"},on:{click:e.addTableColumn}},[e._v("添加列")])],1),t("el-table",{attrs:{data:e.tableForm.columns,border:"",size:"mini","max-height":"300"}},[t("el-table-column",{attrs:{label:"列名",width:"150"},scopedSlots:e._u([{key:"default",fn:function(i){return[t("el-input",{attrs:{placeholder:"列名"},model:{value:i.row.name,callback:function(t){e.$set(i.row,"name",t)},expression:"scope.row.name"}})]}}])}),t("el-table-column",{attrs:{label:"类型",width:"120"},scopedSlots:e._u([{key:"default",fn:function(i){return[t("el-select",{attrs:{placeholder:"类型"},model:{value:i.row.type,callback:function(t){e.$set(i.row,"type",t)},expression:"scope.row.type"}},[t("el-option",{attrs:{value:"VARCHAR"}}),t("el-option",{attrs:{value:"INTEGER"}}),t("el-option",{attrs:{value:"DATE"}}),t("el-option",{attrs:{value:"TIMESTAMP"}}),t("el-option",{attrs:{value:"DECIMAL"}}),t("el-option",{attrs:{value:"TEXT"}})],1)]}}])}),t("el-table-column",{attrs:{label:"长度",width:"80"},scopedSlots:e._u([{key:"default",fn:function(i){return[t("el-input",{attrs:{disabled:["INTEGER","DATE","TIMESTAMP","TEXT"].includes(i.row.type)},model:{value:i.row.length,callback:function(t){e.$set(i.row,"length",t)},expression:"scope.row.length"}})]}}])}),t("el-table-column",{attrs:{label:"主键",width:"60",align:"center"},scopedSlots:e._u([{key:"default",fn:function(i){return[t("el-checkbox",{model:{value:i.row.pk,callback:function(t){e.$set(i.row,"pk",t)},expression:"scope.row.pk"}})]}}])}),t("el-table-column",{attrs:{label:"非空",width:"60",align:"center"},scopedSlots:e._u([{key:"default",fn:function(i){return[t("el-checkbox",{model:{value:i.row.notNull,callback:function(t){e.$set(i.row,"notNull",t)},expression:"scope.row.notNull"}})]}}])}),t("el-table-column",{attrs:{label:"操作",width:"60",align:"center"},scopedSlots:e._u([{key:"default",fn:function(i){return[t("el-button",{staticStyle:{color:"#f56c6c"},attrs:{type:"text",icon:"el-icon-delete"},on:{click:function(t){return e.removeTableColumn(i.$index)}}})]}}])})],1)],1),t("div",{attrs:{slot:"footer"},slot:"footer"},[t("el-button",{attrs:{size:"small"},on:{click:function(t){e.createTableVisible=!1}}},[e._v("取消")]),t("el-button",{attrs:{size:"small",type:"primary",loading:e.submitting},on:{click:e.submitCreateTable}},[e._v("创建")])],1)],1),t("el-dialog",{attrs:{title:"新建视图",visible:e.createViewVisible,width:"600px","close-on-click-modal":!1},on:{"update:visible":function(t){e.createViewVisible=t}}},[t("el-form",{attrs:{model:e.viewForm,size:"small","label-width":"80px"}},[t("el-form-item",{attrs:{label:"视图名",required:""}},[t("el-input",{attrs:{placeholder:"例如: V_USER_STATS"},model:{value:e.viewForm.name,callback:function(t){e.$set(e.viewForm,"name",t)},expression:"viewForm.name"}})],1),t("el-form-item",{attrs:{label:"定义SQL",required:""}},[t("el-input",{attrs:{type:"textarea",rows:8,placeholder:"SELECT * FROM ..."},model:{value:e.viewForm.sql,callback:function(t){e.$set(e.viewForm,"sql",t)},expression:"viewForm.sql"}})],1)],1),t("div",{attrs:{slot:"footer"},slot:"footer"},[t("el-button",{attrs:{size:"small"},on:{click:function(t){e.createViewVisible=!1}}},[e._v("取消")]),t("el-button",{attrs:{size:"small",type:"primary",loading:e.submitting},on:{click:e.submitCreateView}},[e._v("创建")])],1)],1),t("el-dialog",{attrs:{title:"新建触发器",visible:e.createTriggerVisible,width:"600px","close-on-click-modal":!1},on:{"update:visible":function(t){e.createTriggerVisible=t}}},[t("el-alert",{staticStyle:{"margin-bottom":"10px"},attrs:{title:"触发器定义较复杂，请直接输入完整 Create SQL",type:"info",closable:!1}}),t("el-input",{attrs:{type:"textarea",rows:12,placeholder:"CREATE OR REPLACE TRIGGER ..."},model:{value:e.triggerSql,callback:function(t){e.triggerSql=t},expression:"triggerSql"}}),t("div",{attrs:{slot:"footer"},slot:"footer"},[t("el-button",{attrs:{size:"small"},on:{click:function(t){e.createTriggerVisible=!1}}},[e._v("取消")]),t("el-button",{attrs:{size:"small",type:"primary",loading:e.submitting},on:{click:e.submitCreateTrigger}},[e._v("创建")])],1)],1)],1)}),c=[],d=(i("14d9"),i("f665"),i("7d54"),i("ab43"),i("a732"),i("1236"),i("e9c4"),i("cee4"));const h=d["a"].create({baseURL:"/api",timeout:6e4});h.interceptors.request.use(e=>e,e=>(console.log(e),Promise.reject(e))),h.interceptors.response.use(e=>e,e=>(console.log("err"+e),Object(s["Message"])({message:e.message||"请求失败",type:"error",duration:5e3}),Promise.reject(e)));var u=h,f=function(){var e=this,t=e._self._c;return t("div",{staticClass:"table-detail-wrapper"},[t("el-container",{staticClass:"main-workspace"},[t("el-header",{staticClass:"workspace-header",attrs:{height:"50px"}},[t("div",{staticClass:"header-left"},[t("el-breadcrumb",{attrs:{separator:"/"}},[t("el-breadcrumb-item",[t("i",{staticClass:"el-icon-connection"}),e._v(" "+e._s(e.connName))]),t("el-breadcrumb-item",[e._v(e._s(e.currentSchema))]),t("el-breadcrumb-item",["view"===e.tableType?t("i",{staticClass:"el-icon-view",staticStyle:{color:"#E6A23C","margin-right":"4px"}}):t("i",{staticClass:"el-icon-document-copy",staticStyle:{color:"#409EFF","margin-right":"4px"}}),t("b",[e._v(e._s(e.activeTable))])])],1)],1),t("div",{staticClass:"header-right"},[t("el-button-group",{staticStyle:{"margin-right":"15px"}},[t("el-button",{attrs:{size:"small",icon:"el-icon-document"},on:{click:e.handleShowDDL}},[e._v("查看DDL")]),"table"===e.tableType?t("el-button",{attrs:{size:"small",icon:"el-icon-edit-outline"},on:{click:e.handleDesignTable}},[e._v("设计表")]):"view"===e.tableType?t("el-button",{attrs:{size:"small",icon:"el-icon-edit"},on:{click:e.handleEditView}},[e._v("修改视图")]):e._e()],1),t("el-radio-group",{attrs:{size:"small"},on:{change:e.handleViewModeSwitch},model:{value:e.viewMode,callback:function(t){e.viewMode=t},expression:"viewMode"}},[t("el-radio-button",{attrs:{label:"data"}},[t("i",{staticClass:"el-icon-s-grid"}),e._v(" 数据视图")]),t("el-radio-button",{attrs:{label:"relation"}},[t("i",{staticClass:"el-icon-share"}),e._v(" 关联关系")]),t("el-radio-button",{attrs:{label:"sql"}},[t("i",{staticClass:"el-icon-cpu"}),e._v(" SQL终端")])],1)],1)]),t("el-main",{staticClass:"content-area"},["data"===e.viewMode?t("div",{key:"view-data",staticClass:"full-height view-container"},[t("div",{staticClass:"filter-card"},[t("div",{staticClass:"compact-query-panel"},[t("div",{staticClass:"query-actions-top-bar"},[t("div",{staticClass:"left-btns"},[t("span",{staticClass:"panel-title"},[t("i",{staticClass:"el-icon-search"}),e._v(" 筛选条件")]),t("el-divider",{attrs:{direction:"vertical"}}),t("el-button",{attrs:{type:"text",size:"mini",icon:"el-icon-plus"},on:{click:e.addCondition}},[e._v("添加条件")]),e.conditions.length>1?[t("span",{staticClass:"v-divider"}),t("el-radio-group",{attrs:{size:"mini"},model:{value:e.logicalOperator,callback:function(t){e.logicalOperator=t},expression:"logicalOperator"}},[t("el-radio",{attrs:{label:"AND"}},[e._v("AND")]),t("el-radio",{attrs:{label:"OR"}},[e._v("OR")])],1)]:e._e()],2),t("div",{staticClass:"right-btns"},[t("el-button",{attrs:{type:"primary",size:"mini",icon:"el-icon-search",loading:e.loading},on:{click:e.handleQuery}},[e._v("查询")]),t("el-button",{attrs:{size:"mini",icon:"el-icon-refresh-left"},on:{click:e.resetFilters}},[e._v("重置")])],1)]),e.conditions.length>0?t("div",{staticClass:"query-conditions-scroll-area"},[t("div",{staticClass:"query-grid"},e._l(e.conditions,(function(i,a){return t("div",{key:a,staticClass:"query-item"},[t("span",{staticClass:"cond-index"},[e._v(e._s(a+1)+".")]),t("el-select",{staticClass:"field-sel",attrs:{placeholder:"字段",size:"mini",filterable:""},model:{value:i.field,callback:function(t){e.$set(i,"field",t)},expression:"cond.field"}},e._l(e.tableColumns,(function(i){return t("el-option",{key:i.COLUMN_NAME+"_"+(i.COMMENTS||""),attrs:{label:i.COLUMN_NAME,value:i.COLUMN_NAME}},[t("span",{staticStyle:{float:"left"}},[e._v(e._s(i.COLUMN_NAME))]),t("span",{staticStyle:{float:"right",color:"#8492a6","font-size":"12px"}},[e._v(e._s(i.COMMENTS))])])})),1),t("el-select",{staticClass:"op-sel",attrs:{size:"mini"},model:{value:i.operator,callback:function(t){e.$set(i,"operator",t)},expression:"cond.operator"}},[t("el-option",{attrs:{label:"=",value:"="}}),t("el-option",{attrs:{label:"LIKE",value:"LIKE"}}),t("el-option",{attrs:{label:">",value:">"}}),t("el-option",{attrs:{label:"<",value:"<"}}),t("el-option",{attrs:{label:"IS NULL",value:"IS NULL"}})],1),i.operator.includes("NULL")?e._e():t("el-input",{staticClass:"val-input",attrs:{placeholder:"值",size:"mini"},nativeOn:{keyup:function(t){return!t.type.indexOf("key")&&e._k(t.keyCode,"enter",13,t.key,"Enter")?null:e.handleQuery.apply(null,arguments)}},model:{value:i.value,callback:function(t){e.$set(i,"value",t)},expression:"cond.value"}}),t("el-button",{staticClass:"cond-del",attrs:{type:"text",icon:"el-icon-close"},on:{click:function(t){return e.removeCondition(a)}}})],1)})),0)]):e._e()])]),t("div",{staticClass:"table-card"},[t("div",{staticClass:"data-toolbar"},[e.isReadOnly?t("div",{staticClass:"tool-left"},[t("el-tag",{staticStyle:{"margin-right":"10px"},attrs:{size:"small",type:"warning",effect:"plain"}},[t("i",{staticClass:"el-icon-lock"}),e._v(" 复杂视图 (只读)")]),t("el-button",{attrs:{size:"mini",icon:"el-icon-refresh"},on:{click:e.loadData}},[e._v("刷新数据")])],1):t("div",{staticClass:"tool-left"},[t("el-button",{attrs:{size:"mini",icon:"el-icon-plus"},on:{click:e.handleAddRow}},[e._v("插入行")]),t("el-button",{attrs:{size:"mini",type:"success",icon:"el-icon-check",disabled:!e.hasChanges,loading:e.saving},on:{click:e.submitBatchChanges}},[e._v("保存修改")]),t("el-button",{attrs:{size:"mini",icon:"el-icon-close",disabled:!e.hasChanges},on:{click:e.handleDiscardChanges}},[e._v("放弃修改")]),t("el-divider",{attrs:{direction:"vertical"}}),"view"===e.tableType?t("el-tag",{staticStyle:{"margin-right":"10px"},attrs:{size:"small",type:"success",effect:"plain"}},[e._v("简单视图 (可编辑)")]):e._e(),t("el-button",{attrs:{size:"mini",icon:"el-icon-refresh"},on:{click:e.loadData}},[e._v("刷新")])],1),t("div",{staticClass:"data-stats"},[e.hasChanges?t("span",{staticStyle:{color:"#E6A23C","margin-right":"10px"}},[t("i",{staticClass:"el-icon-warning"}),e._v(" 有未保存的更改")]):e._e(),t("i",{staticClass:"el-icon-info"}),e._v(" 共 "),t("b",[e._v(e._s(e.totalCount))]),e._v(" 条记录 ")])]),t("div",{directives:[{name:"loading",rawName:"v-loading",value:e.loading,expression:"loading"}],staticClass:"table-wrapper"},[t("el-table",{ref:"dataTable",staticClass:"custom-table",attrs:{data:e.currentDataList,border:"",height:"100%",size:"mini",stripe:"","highlight-current-row":"","cell-style":e.getCellStyle},on:{"sort-change":e.handleSortChange,"cell-dblclick":e.handleCellDblClick}},[t("el-table-column",{attrs:{type:"index",width:"55",align:"center",fixed:"left",label:"#",index:e.indexMethod}}),e.tableColumns.length>0?e._l(e.tableColumns,(function(i){return t("el-table-column",{key:i.COLUMN_NAME,attrs:{prop:i.COLUMN_NAME,"min-width":"150","show-overflow-tooltip":"",sortable:"custom"},scopedSlots:e._u([{key:"header",fn:function(a){return[t("div",{staticClass:"custom-header"},[t("div",{staticClass:"col-name"},[1==i.IS_PK?t("i",{staticClass:"el-icon-key",staticStyle:{color:"#E6A23C"},attrs:{title:"主键"}}):e._e(),e._v(" "+e._s(i.COLUMN_NAME))]),i.COMMENTS?t("div",{staticClass:"col-comment"},[e._v(e._s(i.COMMENTS))]):e._e()])]}},{key:"default",fn:function(a){return[!e.isReadOnly&&e.isCellEditing(a.row,i.COLUMN_NAME)?t("div",{staticClass:"inline-input-box"},[t("el-input",{attrs:{size:"mini"},on:{blur:function(t){return e.finishEditing(a.row,i.COLUMN_NAME)}},nativeOn:{keyup:function(t){return!t.type.indexOf("key")&&e._k(t.keyCode,"enter",13,t.key,"Enter")?null:t.target.blur()}},model:{value:a.row[i.COLUMN_NAME],callback:function(t){e.$set(a.row,i.COLUMN_NAME,t)},expression:"scope.row[col.COLUMN_NAME]"}})],1):t("span",[e._v(e._s(a.row[i.COLUMN_NAME]))])]}}],null,!0)})})):e._e(),e.isReadOnly?e._e():t("el-table-column",{attrs:{label:"操作",width:"80",fixed:"right",align:"center"},scopedSlots:e._u([{key:"default",fn:function(i){return[t("el-button",{staticClass:"danger-text",attrs:{type:"text",size:"mini",icon:"el-icon-delete"},on:{click:function(t){return e.handleDeleteRow(i.$index,i.row)}}})]}}],null,!1,198239717)})],2)],1),t("div",{staticClass:"pagination-bar"},[t("el-pagination",{attrs:{"current-page":e.currentPage,"page-sizes":[20,50,100],"page-size":e.pageSize,layout:"total, sizes, prev, pager, next, jumper",total:e.totalCount},on:{"size-change":e.handleSizeChange,"current-change":e.handleCurrentChange}})],1)])]):"relation"===e.viewMode?t("div",{key:"view-relation",staticClass:"relation-view-container view-container"},[t("div",{staticClass:"relation-toolbar"},[t("div",{staticClass:"legend-box"},[t("span",{staticClass:"legend-item"},[t("span",{staticClass:"dot active"}),e._v(" 当前表")]),t("span",{staticClass:"legend-item"},[t("span",{staticClass:"dot normal"}),e._v(" 关联表")]),t("el-divider",{attrs:{direction:"vertical"}}),t("el-switch",{attrs:{"active-text":"全部展开",size:"mini"},on:{change:e.handleShowAllChange},model:{value:e.showAllColumns,callback:function(t){e.showAllColumns=t},expression:"showAllColumns"}})],1),t("div",{staticClass:"zoom-btns"},[t("el-button-group",[t("el-button",{attrs:{size:"mini",icon:"el-icon-zoom-in"},on:{click:function(t){return e.handleGraphZoom(1.1)}}}),t("el-button",{attrs:{size:"mini",icon:"el-icon-zoom-out"},on:{click:function(t){return e.handleGraphZoom(.9)}}}),t("el-button",{attrs:{size:"mini",icon:"el-icon-aim"},on:{click:e.handleGraphFit}})],1)],1)]),t("div",{staticClass:"canvas-wrapper"},[t("div",{ref:"relationCanvas",staticClass:"g6-canvas-box"})])]):"sql"===e.viewMode?t("div",{key:"view-sql",staticClass:"full-height view-container"},[t("div",{staticClass:"sql-box",staticStyle:{height:"300px",padding:"0",border:"1px solid #dcdfe6",overflow:"hidden",display:"flex","flex-direction":"column"}},[t("SqlEditor",{staticStyle:{flex:"1"},attrs:{language:"sql"},model:{value:e.customSql,callback:function(t){e.customSql=t},expression:"customSql"}})],1),t("div",{staticStyle:{"text-align":"right",padding:"10px 0"}},[t("el-button",{attrs:{type:"success",size:"small",icon:"el-icon-video-play"},on:{click:e.runSql}},[e._v("执行 SQL")])],1),e.sqlResult.length?t("div",{staticClass:"sql-result"},[t("el-divider",{attrs:{"content-position":"left"}},[e._v("结果预览")]),t("el-table",{attrs:{data:e.sqlResult,border:"",height:"100%",size:"mini",stripe:""}},e._l(e.sqlResult[0],(function(e,i){return t("el-table-column",{key:i,attrs:{prop:i,label:i,"show-overflow-tooltip":""}})})),1)],1):e._e()]):e._e()])],1),t("el-dialog",{attrs:{title:"编辑视图定义",visible:e.editViewVisible,width:"900px","append-to-body":"","close-on-click-modal":!1},on:{"update:visible":function(t){e.editViewVisible=t}}},[t("div",{staticStyle:{"margin-bottom":"10px"}},[t("el-alert",{attrs:{title:"修改视图定义将执行 CREATE OR REPLACE VIEW 语句。",type:"warning","show-icon":"",closable:!1}})],1),t("div",{staticStyle:{height:"450px",border:"1px solid #dcdfe6"}},[t("SqlEditor",{attrs:{language:"sql"},model:{value:e.viewSql,callback:function(t){e.viewSql=t},expression:"viewSql"}})],1),t("div",{attrs:{slot:"footer"},slot:"footer"},[t("el-button",{on:{click:function(t){e.editViewVisible=!1}}},[e._v("取消")]),t("el-button",{attrs:{type:"primary",loading:e.altering},on:{click:e.submitViewAlter}},[e._v("保存修改")])],1)]),t("el-dialog",{attrs:{title:e.conflictTitle,visible:e.conflictVisible,width:"750px","append-to-body":"","close-on-click-modal":!1},on:{"update:visible":function(t){e.conflictVisible=t}}},[t("div",{staticClass:"conflict-alert",style:{backgroundColor:e.isParentMissing?"#fef0f0":"#fdf6ec",color:e.isParentMissing?"#F56C6C":"#e6a23c",borderColor:e.isParentMissing?"#fde2e2":"#faecd8"}},[t("i",{staticClass:"el-icon-warning",staticStyle:{"margin-right":"8px"}}),e._v(" "+e._s(e.conflictMessage)+" ")]),t("el-table",{staticStyle:{"margin-top":"15px"},attrs:{data:e.conflictList,border:"",size:"small"}},[t("el-table-column",{attrs:{label:e.isParentMissing?"目标主表名":"引用表名",width:"220",prop:"TABLE_NAME"},scopedSlots:e._u([{key:"default",fn:function(i){return[t("el-tag",{attrs:{size:"mini",type:"info"}},[e._v(e._s(i.row.TABLE_NAME))])]}}])}),t("el-table-column",{attrs:{label:e.isParentMissing?"目标主键列":"关联字段",width:"180",prop:"COLUMN_NAME"}}),t("el-table-column",{attrs:{label:e.isParentMissing?"状态":"冲突记录数",align:"center",width:"120"},scopedSlots:e._u([{key:"default",fn:function(i){return["MISSING"===i.row.CNT?t("span",{staticStyle:{color:"#F56C6C","font-weight":"bold"}},[e._v("主键缺失")]):t("span",{staticStyle:{color:"#F56C6C","font-weight":"bold"}},[e._v(e._s(i.row.CNT))])]}}])}),t("el-table-column",{attrs:{label:"操作",align:"center"},scopedSlots:e._u([{key:"default",fn:function(i){return[t("el-button",{attrs:{type:"primary",plain:"",size:"mini"},on:{click:function(t){return e.resolveConflict(i.row)}}},[e._v(" 去处理 "),t("i",{staticClass:"el-icon-right"})])]}}])})],1),t("div",{attrs:{slot:"footer"},slot:"footer"},[t("el-button",{on:{click:function(t){e.conflictVisible=!1}}},[e._v("关闭")])],1)],1),t("el-dialog",{attrs:{title:"DDL 预览",visible:e.ddlVisible,width:"800px","append-to-body":""},on:{"update:visible":function(t){e.ddlVisible=t}}},[t("div",{staticStyle:{height:"500px",border:"1px solid #dcdfe6"}},[t("SqlEditor",{attrs:{readOnly:!0},model:{value:e.currentDDL,callback:function(t){e.currentDDL=t},expression:"currentDDL"}})],1),t("div",{attrs:{slot:"footer"},slot:"footer"},[t("el-button",{on:{click:function(t){e.ddlVisible=!1}}},[e._v("关闭")])],1)]),t("el-dialog",{attrs:{title:"设计表结构",visible:e.designVisible,width:"1100px","append-to-body":"","close-on-click-modal":!1,top:"5vh"},on:{"update:visible":function(t){e.designVisible=t}}},[t("div",{staticStyle:{"margin-bottom":"10px"}},[t("el-alert",{attrs:{title:"注意：修改结构会生成 ALTER TABLE 语句。请谨慎操作。",type:"warning","show-icon":"",closable:!1}})],1),t("el-tabs",{attrs:{type:"card"},model:{value:e.designActiveTab,callback:function(t){e.designActiveTab=t},expression:"designActiveTab"}},[t("el-tab-pane",{attrs:{label:"字段列 (Columns)",name:"columns"}},[t("div",{staticStyle:{"margin-bottom":"10px","text-align":"right"}},[t("el-button",{attrs:{size:"mini",type:"primary",icon:"el-icon-plus"},on:{click:e.addDesignColumn}},[e._v("添加列")])],1),t("el-table",{attrs:{data:e.designColumns,border:"",size:"mini",height:"400"}},[t("el-table-column",{attrs:{label:"状态",width:"50",align:"center"},scopedSlots:e._u([{key:"default",fn:function(i){return["new"===i.row._status?t("i",{staticClass:"el-icon-plus",staticStyle:{color:"green","font-weight":"bold"},attrs:{title:"新增"}}):"modified"===i.row._status?t("i",{staticClass:"el-icon-edit",staticStyle:{color:"orange","font-weight":"bold"},attrs:{title:"修改"}}):t("span",{staticStyle:{color:"#ccc"}},[e._v("-")])]}}])}),t("el-table-column",{attrs:{label:"列名",width:"150"},scopedSlots:e._u([{key:"default",fn:function(i){return[t("el-input",{attrs:{size:"mini"},on:{change:function(t){return e.markModified(i.row)}},model:{value:i.row.COLUMN_NAME,callback:function(t){e.$set(i.row,"COLUMN_NAME",t)},expression:"scope.row.COLUMN_NAME"}})]}}])}),t("el-table-column",{attrs:{label:"类型",width:"120"},scopedSlots:e._u([{key:"default",fn:function(i){return[t("el-select",{attrs:{size:"mini",filterable:"","allow-create":""},on:{change:function(t){return e.markModified(i.row)}},model:{value:i.row.DATA_TYPE,callback:function(t){e.$set(i.row,"DATA_TYPE",t)},expression:"scope.row.DATA_TYPE"}},[t("el-option",{attrs:{value:"VARCHAR2"}}),t("el-option",{attrs:{value:"NUMBER"}}),t("el-option",{attrs:{value:"DATE"}})],1)]}}])}),t("el-table-column",{attrs:{label:"长度",width:"100"},scopedSlots:e._u([{key:"default",fn:function(i){return[t("el-input",{attrs:{size:"mini"},on:{change:function(t){return e.markModified(i.row)}},model:{value:i.row.DATA_LENGTH,callback:function(t){e.$set(i.row,"DATA_LENGTH",t)},expression:"scope.row.DATA_LENGTH"}})]}}])}),t("el-table-column",{attrs:{label:"主键",width:"50"},scopedSlots:e._u([{key:"default",fn:function(i){return[t("el-checkbox",{on:{change:function(t){return e.handlePkChange(i.row)}},model:{value:i.row.IS_PK,callback:function(t){e.$set(i.row,"IS_PK",t)},expression:"scope.row.IS_PK"}})]}}])}),t("el-table-column",{attrs:{label:"空",width:"50"},scopedSlots:e._u([{key:"default",fn:function(i){return[t("el-checkbox",{attrs:{"true-label":"Y","false-label":"N"},on:{change:function(t){return e.markModified(i.row)}},model:{value:i.row.NULLABLE,callback:function(t){e.$set(i.row,"NULLABLE",t)},expression:"scope.row.NULLABLE"}})]}}])}),t("el-table-column",{attrs:{label:"默认",width:"100"},scopedSlots:e._u([{key:"default",fn:function(i){return[t("el-input",{attrs:{size:"mini"},on:{change:function(t){return e.markModified(i.row)}},model:{value:i.row.DATA_DEFAULT,callback:function(t){e.$set(i.row,"DATA_DEFAULT",t)},expression:"scope.row.DATA_DEFAULT"}})]}}])}),t("el-table-column",{attrs:{label:"注释"},scopedSlots:e._u([{key:"default",fn:function(i){return[t("el-input",{attrs:{size:"mini"},on:{change:function(t){return e.markModified(i.row)}},model:{value:i.row.COMMENTS,callback:function(t){e.$set(i.row,"COMMENTS",t)},expression:"scope.row.COMMENTS"}})]}}])}),t("el-table-column",{attrs:{label:"操作"},scopedSlots:e._u([{key:"default",fn:function(i){return[t("el-button",{staticStyle:{color:"#F56C6C"},attrs:{type:"text",icon:"el-icon-delete"},on:{click:function(t){return e.removeDesignColumn(i.$index,i.row)}}})]}}])})],1)],1),t("el-tab-pane",{attrs:{label:"索引 (Indexes)",name:"indexes"}},[t("div",{staticStyle:{"margin-bottom":"10px","text-align":"right"}},[t("el-button",{attrs:{size:"mini",type:"primary",icon:"el-icon-plus"},on:{click:e.addDesignIndex}},[e._v("添加索引")])],1),t("el-table",{attrs:{data:e.designIndexes,border:"",size:"mini",height:"400"}},[t("el-table-column",{attrs:{label:"状态",width:"50",align:"center"},scopedSlots:e._u([{key:"default",fn:function(i){return["new"===i.row._status?t("i",{staticClass:"el-icon-plus",staticStyle:{color:"green","font-weight":"bold"},attrs:{title:"新增"}}):t("span",{staticStyle:{color:"#ccc"}},[e._v("-")])]}}])}),t("el-table-column",{attrs:{label:"索引名称",width:"200"},scopedSlots:e._u([{key:"default",fn:function(i){return[t("el-input",{attrs:{size:"mini",placeholder:"IDX_表名_字段"},model:{value:i.row.INDEX_NAME,callback:function(t){e.$set(i.row,"INDEX_NAME",t)},expression:"scope.row.INDEX_NAME"}})]}}])}),t("el-table-column",{attrs:{label:"类型",width:"120"},scopedSlots:e._u([{key:"default",fn:function(i){return[t("el-select",{attrs:{size:"mini"},model:{value:i.row.INDEX_TYPE,callback:function(t){e.$set(i.row,"INDEX_TYPE",t)},expression:"scope.row.INDEX_TYPE"}},[t("el-option",{attrs:{label:"Normal",value:"NORMAL"}}),t("el-option",{attrs:{label:"Unique",value:"UNIQUE"}}),t("el-option",{attrs:{label:"Bitmap",value:"BITMAP"}})],1)]}}])}),t("el-table-column",{attrs:{label:"包含列"},scopedSlots:e._u([{key:"default",fn:function(i){return[t("el-select",{staticStyle:{width:"100%"},attrs:{multiple:"",size:"mini"},model:{value:i.row.COLUMNS,callback:function(t){e.$set(i.row,"COLUMNS",t)},expression:"scope.row.COLUMNS"}},e._l(e.designColumns,(function(e){return t("el-option",{key:e.COLUMN_NAME,attrs:{label:e.COLUMN_NAME,value:e.COLUMN_NAME}})})),1)]}}])}),t("el-table-column",{attrs:{label:"操作",width:"60",align:"center"},scopedSlots:e._u([{key:"default",fn:function(i){return[t("el-button",{staticStyle:{color:"#F56C6C"},attrs:{type:"text",icon:"el-icon-delete"},on:{click:function(t){return e.removeDesignIndex(i.$index,i.row)}}})]}}])})],1)],1),t("el-tab-pane",{attrs:{label:"外键 (Foreign Keys)",name:"fks"}},[t("div",{staticStyle:{"margin-bottom":"10px","text-align":"right"}},[t("el-button",{attrs:{size:"mini",type:"primary",icon:"el-icon-plus"},on:{click:e.addDesignFk}},[e._v("添加外键")])],1),t("el-table",{attrs:{data:e.designForeignKeys,border:"",size:"mini",height:"400"}},[t("el-table-column",{attrs:{label:"状态",width:"50",align:"center"},scopedSlots:e._u([{key:"default",fn:function(i){return["new"===i.row._status?t("i",{staticClass:"el-icon-plus",staticStyle:{color:"green","font-weight":"bold"},attrs:{title:"新增"}}):t("span",{staticStyle:{color:"#ccc"}},[e._v("-")])]}}])}),t("el-table-column",{attrs:{label:"外键名称",width:"180"},scopedSlots:e._u([{key:"default",fn:function(i){return[t("el-input",{attrs:{size:"mini",placeholder:"FK_..."},model:{value:i.row.CONSTRAINT_NAME,callback:function(t){e.$set(i.row,"CONSTRAINT_NAME",t)},expression:"scope.row.CONSTRAINT_NAME"}})]}}])}),t("el-table-column",{attrs:{label:"本表字段",width:"150"},scopedSlots:e._u([{key:"default",fn:function(i){return[t("el-select",{attrs:{size:"mini",filterable:""},model:{value:i.row.COLUMN_NAME,callback:function(t){e.$set(i.row,"COLUMN_NAME",t)},expression:"scope.row.COLUMN_NAME"}},e._l(e.designColumns,(function(e){return t("el-option",{key:e.COLUMN_NAME,attrs:{label:e.COLUMN_NAME,value:e.COLUMN_NAME}})})),1)]}}])}),t("el-table-column",{attrs:{label:"关联主表",width:"180"},scopedSlots:e._u([{key:"default",fn:function(i){return[t("el-select",{attrs:{size:"mini",filterable:"","allow-create":"",placeholder:"选择目标表"},on:{change:function(t){return e.handleRefTableChange(i.row)}},model:{value:i.row.R_TABLE_NAME,callback:function(t){e.$set(i.row,"R_TABLE_NAME",t)},expression:"scope.row.R_TABLE_NAME"}},e._l(e.allTableNames,(function(e){return t("el-option",{key:e,attrs:{label:e,value:e}})})),1)]}}])}),t("el-table-column",{attrs:{label:"关联主表字段",width:"150"},scopedSlots:e._u([{key:"default",fn:function(i){return[t("el-select",{attrs:{size:"mini",filterable:"",placeholder:"目标列"},on:{"visible-change":t=>t&&e.loadRefColumns(i.row.R_TABLE_NAME)},model:{value:i.row.R_COLUMN_NAME,callback:function(t){e.$set(i.row,"R_COLUMN_NAME",t)},expression:"scope.row.R_COLUMN_NAME"}},e._l(e.refColumnsCache[i.row.R_TABLE_NAME]||[],(function(i){return t("el-option",{key:i.COLUMN_NAME,attrs:{label:i.COLUMN_NAME,value:i.COLUMN_NAME}},[t("span",{staticStyle:{float:"left"}},[e._v(e._s(i.COLUMN_NAME))]),t("span",{staticStyle:{float:"right",color:"#8492a6","font-size":"12px"}},[e._v(e._s(i.COMMENTS))])])})),1)]}}])}),t("el-table-column",{attrs:{label:"删除规则",width:"120"},scopedSlots:e._u([{key:"default",fn:function(i){return[t("el-select",{attrs:{size:"mini"},model:{value:i.row.DELETE_RULE,callback:function(t){e.$set(i.row,"DELETE_RULE",t)},expression:"scope.row.DELETE_RULE"}},[t("el-option",{attrs:{label:"No Action",value:"NO ACTION"}}),t("el-option",{attrs:{label:"Cascade",value:"CASCADE"}}),t("el-option",{attrs:{label:"Set Null",value:"SET NULL"}})],1)]}}])}),t("el-table-column",{attrs:{label:"操作",width:"60",align:"center"},scopedSlots:e._u([{key:"default",fn:function(i){return[t("el-button",{staticStyle:{color:"#F56C6C"},attrs:{type:"text",icon:"el-icon-delete"},on:{click:function(t){return e.removeDesignFk(i.$index,i.row)}}})]}}])})],1)],1)],1),t("div",{attrs:{slot:"footer"},slot:"footer"},[t("el-button",{on:{click:function(t){e.designVisible=!1}}},[e._v("取消")]),t("el-button",{attrs:{type:"primary"},on:{click:e.generateAndRunAlter}},[e._v("预览并保存")])],1)],1),t("el-dialog",{attrs:{title:"确认修改",visible:e.sqlConfirmVisible,width:"600px","append-to-body":""},on:{"update:visible":function(t){e.sqlConfirmVisible=t}}},[t("div",{staticStyle:{"margin-bottom":"10px"}},[e._v("即将执行以下变更语句：")]),t("div",{staticStyle:{height:"300px",border:"1px solid #dcdfe6"}},[t("SqlEditor",{model:{value:e.generatedSql,callback:function(t){e.generatedSql=t},expression:"generatedSql"}})],1),t("div",{attrs:{slot:"footer"},slot:"footer"},[t("el-button",{on:{click:function(t){e.sqlConfirmVisible=!1}}},[e._v("取消")]),t("el-button",{attrs:{type:"primary",loading:e.altering},on:{click:e.executeAlter}},[e._v("确认执行")])],1)])],1)},p=[],m=(i("d9e2"),i("d866"),i("1e70"),i("79a4"),i("c1a1"),i("8b00"),i("a4e7"),i("1e5a"),i("72c3"),i("7c3e0")),b=function(){var e=this,t=e._self._c;return t("div",{ref:"editorContainer",staticClass:"monaco-editor-container"})},g=[],N=i("c2c6"),E={name:"SqlEditor",props:{value:{type:String,default:""},language:{type:String,default:"sql"},readOnly:{type:Boolean,default:!1},theme:{type:String,default:"vs"}},data(){return{editor:null}},watch:{value(e){this.editor&&e!==this.editor.getValue()&&this.editor.setValue(e)},language(e){this.editor&&N["editor"].setModelLanguage(this.editor.getModel(),e)}},mounted(){this.initEditor(),window.addEventListener("resize",this.handleResize)},beforeDestroy(){this.editor&&this.editor.dispose(),window.removeEventListener("resize",this.handleResize)},methods:{initEditor(){this.editor=N["editor"].create(this.$refs.editorContainer,{value:this.value,language:this.language,theme:this.theme,readOnly:this.readOnly,automaticLayout:!0,fontSize:14,minimap:{enabled:!1},scrollBeyondLastLine:!1,lineNumbers:"on",roundedSelection:!1,scrollBeyondLastLine:!1}),this.editor.onDidChangeModelContent(()=>{const e=this.editor.getValue();this.$emit("input",e),this.$emit("change",e)})},handleResize(){this.editor&&this.editor.layout()}}},C=E,v=(i("3dd0"),i("2877")),w=Object(v["a"])(C,b,g,!1,null,"338e8267",null),_=w.exports;m["a"].registerNode("db-table",{draw:(e,t)=>{const{label:i,tableComment:a,columns:s=[],isCenter:n,isTruncated:l,totalColCount:o}=e,r=300,c=50,d=28,h=s.length*d;let u=0;(l||o>10)&&(u=24);const f=c+h+u+8;t.addShape("rect",{attrs:{x:0,y:0,width:r,height:f,fill:"#fff",stroke:n?"#409EFF":"#DCDFE6",lineWidth:1,radius:4},name:"container-shape"}),t.addShape("rect",{attrs:{x:0,y:0,width:r,height:c,fill:n?"#409EFF":"#F2F6FC",radius:[4,4,0,0]},name:"header-shape"}),t.addShape("text",{attrs:{x:10,y:20,text:i,fill:n?"#fff":"#333",fontSize:13,fontWeight:"bold",textBaseline:"middle"},name:"title-text"}),a&&t.addShape("text",{attrs:{x:10,y:38,text:a,fill:n?"#eee":"#909399",fontSize:11,textBaseline:"middle"},name:"comment-text"}),s.forEach((e,i)=>{const a=c+i*d+d/2;if(t.addShape("text",{attrs:{x:28,y:a,text:e.COLUMN_NAME,fill:e.IS_PK?"#E6A23C":"#333",fontSize:12,textBaseline:"middle",fontWeight:e.IS_PK?"bold":"normal"}}),e.IS_PK&&t.addShape("circle",{attrs:{x:14,y:a,r:3,fill:"#E6A23C"}}),e.COMMENTS){let i=e.COMMENTS;i.length>10&&(i=i.substring(0,10)+"..."),t.addShape("text",{attrs:{x:160,y:a,text:i,fill:"#909399",fontSize:11,textBaseline:"middle"}})}});const p=c+h+12;return l?t.addShape("text",{attrs:{x:r/2,y:p,text:`... (共 ${o} 列，点击展开)`,fill:"#909399",fontSize:11,textAlign:"center",textBaseline:"middle",cursor:"pointer"},name:"expand-text"}):o>10&&t.addShape("text",{attrs:{x:r/2,y:p,text:"⬆ 点击折叠",fill:"#409EFF",fontSize:11,textAlign:"center",textBaseline:"middle",cursor:"pointer"},name:"collapse-text"}),t.get("children")[0]}});var y={name:"TableDetail",components:{SqlEditor:_},props:["connId","connName","schema","tableName","initialFilter","initViewMode","tableType"],data(){return{currentSchema:this.schema,activeTable:this.tableName,viewMode:this.initViewMode||"data",loading:!1,saving:!1,currentDataList:[],totalCount:0,currentPage:1,pageSize:50,editingCell:null,originalDataMap:{},modifiedRows:new Set,newRows:[],tableColumns:[],conditions:[],logicalOperator:"AND",conflictVisible:!1,conflictList:[],conflictPkValue:null,conflictType:"delete",customSql:"",sqlResult:[],ddlVisible:!1,currentDDL:"",editViewVisible:!1,viewSql:"",isSimpleView:!0,jumpFromConflict:!1,designVisible:!1,designActiveTab:"columns",designColumns:[],originalColumns:[],deleteColumnList:[],designIndexes:[],deleteIndexList:[],designForeignKeys:[],deleteFkList:[],allTableNames:[],refColumnsCache:{},showAllColumns:!1,expandedTableList:[],graphNodeIds:[],sqlConfirmVisible:!1,generatedSql:"",altering:!1}},computed:{rawKeys(){return this.currentDataList.length?Object.keys(this.currentDataList[0]).filter(e=>"DB_INTERNAL_ID"!==e):[]},hasChanges(){return this.modifiedRows.size>0||this.newRows.length>0},isReadOnly(){return"table"!==this.tableType&&("view"!==this.tableType||!this.isSimpleView)},isParentMissing(){return this.conflictList.length>0&&"MISSING"===this.conflictList[0].CNT},conflictTitle(){return this.isParentMissing?"⚠️ 保存失败：目标主键缺失":"delete"===this.conflictType?"⚠️ 无法删除：存在关联引用":"⚠️ 无法修改：存在关联引用"},conflictMessage(){return this.isParentMissing?"您输入的 外键值 在目标主表中不存在。请先在主表中创建该数据，或修改为已存在的值。":`该记录被以下 ${this.conflictList.length} 张表引用，请先处理这些关联数据。`}},mounted(){this.initView()},watch:{initialFilter:{immediate:!0,deep:!0,handler(e){e&&e.field&&void 0!==e.value&&("data"!==this.viewMode&&this.handleViewModeSwitch("data"),this.jumpFromConflict=!0,this.applyAutoFilter(e))}},tableName:{immediate:!0,handler(e){e&&(this.activeTable=e,this.currentSchema=this.schema,this.currentPage=1,this.expandedTableList=[],this.showAllColumns=!1,this.loadData())}},initViewMode(e){e&&e!==this.viewMode&&this.handleViewModeSwitch(e)}},methods:{async request(e,t,i={}){const a={method:e,url:t,headers:{"Conn-Id":this.connId}};return t.startsWith("/db")||(t="/db"+t),a.url=t,"get"===e||"delete"===e?a.params=i:a.data=i,u(a)},handleError(e,t="操作失败"){var i,a;let s=(null===(i=e.response)||void 0===i||null===(i=i.data)||void 0===i?void 0:i.msg)||(null===(a=e.response)||void 0===a||null===(a=a.data)||void 0===a?void 0:a.message)||e.message||"未知错误";s.includes("nested exception is")&&(s=s.split("nested exception is").pop()),s=s.replace(/[\w\.]*Exception:\s*/g,"").trim(),s.length>300&&(s=s.substring(0,300)+"..."),this.$alert(`<div style="font-size: 14px; line-height: 1.5; color: #606266;"><p style="font-weight: bold; color: #F56C6C;">❌ ${t}：</p><p style="background: #fef0f0; padding: 8px; border-radius: 4px; margin: 5px 0; word-break: break-all;">${s}</p></div>`,t,{dangerouslyUseHTMLString:!0,confirmButtonText:"知道了",type:"error",customClass:"error-dialog-width"})},initView(){this.destroyGraph(),"relation"===this.viewMode?this.loadRelations():"data"===this.viewMode&&(this.initialFilter&&this.initialFilter.field||this.loadData())},handleViewModeSwitch(e){this.hasChanges?this.$confirm("当前有未保存的修改，切换视图将丢失这些修改，是否继续？","提示",{type:"warning"}).then(()=>{this.resetEditState(),this._doSwitch(e)}).catch(()=>{this.viewMode="data"}):this._doSwitch(e)},_doSwitch(e){const t="string"===typeof e?e:this.viewMode;this.viewMode=t,this.$emit("view-mode-change",t),"relation"===t?this.$nextTick(()=>{this.loadRelations()}):(this.destroyGraph(),"data"===t&&this.loadData())},async loadData(){this.resetEditState(),this.loading=!0;try{const e=await this.request("get","/columns",{schema:this.currentSchema,tableName:this.activeTable});this.tableColumns=e.data.data||[];let t=[],i=0;const a={schema:this.currentSchema,tableName:this.activeTable,page:this.currentPage,size:this.pageSize};if(this.conditions.length>0){const e=await this.request("post","/filter",{...a,logic:this.logicalOperator,conditions:this.conditions});t=e.data.data.list||[],i=e.data.data.total||0,e.data.data.isView&&(this.isSimpleView=e.data.data.isSimpleView)}else{const e=await this.request("get","/data",a);t=e.data.data.list||[],i=e.data.data.total||0,e.data.data.isView&&(this.isSimpleView=e.data.data.isSimpleView)}this.currentDataList=t,this.totalCount=i,this.originalDataMap={},t.forEach(e=>{e.DB_INTERNAL_ID&&(this.originalDataMap[e.DB_INTERNAL_ID]=JSON.parse(JSON.stringify(e)))}),this.jumpFromConflict&&0===this.totalCount?(this.jumpFromConflict=!1,this.$nextTick(()=>{this.handleAddRow(),this.$message({message:"未找到指定主键记录，已自动为您创建新行并填入主键，请补充其他信息。",type:"success",duration:5e3,showClose:!0})})):this.totalCount>0&&(this.jumpFromConflict=!1)}catch(e){this.handleError(e,"数据加载失败")}finally{this.loading=!1}},async handleEditView(){try{const e=await this.request("get","/ddl",{schema:this.currentSchema,tableName:this.activeTable});let t=e.data.data||"";this.viewSql=t.replace(/&quot;/g,'"').replace(/&apos;/g,"'").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&"),this.editViewVisible=!0}catch(e){this.handleError(e,"获取视图定义失败")}},async submitViewAlter(){this.altering=!0;try{const e=await this.request("post","/execute",{sql:this.viewSql});if(200!==e.data.code)throw new Error(e.data.msg);this.$message.success("视图修改成功"),this.editViewVisible=!1,this.loadData()}catch(e){this.handleError(e,"修改视图失败")}finally{this.altering=!1}},resetEditState(){this.editingCell=null,this.modifiedRows=new Set,this.newRows=[]},handleDiscardChanges(){this.resetEditState(),this.loadData()},handleCellDblClick(e,t){this.isReadOnly||(this.editingCell={rowId:e.DB_INTERNAL_ID||e._tempId,col:t.property},this.$nextTick(()=>{const e=document.getElementsByTagName("input");e&&e.length>0&&e[e.length-1].focus()}))},isCellEditing(e,t){if(!this.editingCell)return!1;const i=e.DB_INTERNAL_ID||e._tempId;return this.editingCell.rowId===i&&this.editingCell.col===t},finishEditing(e,t){this.editingCell=null;const i=e.DB_INTERNAL_ID;if(!i)return;const a=this.originalDataMap[i];let s=e[t],n=a?a[t]:"";null==s&&(s=""),null==n&&(n=""),String(s)!==String(n)&&(this.modifiedRows.add(i),this.modifiedRows=new Set(this.modifiedRows))},getCellStyle({row:e,column:t}){const i=e.DB_INTERNAL_ID,a=t.property;if(!i&&e._tempId)return{backgroundColor:"#f0f9eb"};if(this.modifiedRows.has(i)){const t=this.originalDataMap[i];let s=e[a],n=t?t[a]:"";if(null==s&&(s=""),null==n&&(n=""),String(s)!==String(n))return{backgroundColor:"#fdf6ec",color:"#E6A23C",fontWeight:"bold"}}return{}},handleAddRow(){const e={_tempId:"NEW_"+Date.now()};if(this.tableColumns.forEach(t=>e[t.COLUMN_NAME]=null),1===this.conditions.length&&"="===this.conditions[0].operator){const t=this.conditions[0].field,i=this.conditions[0].value,a=Object.keys(e).find(e=>e.toUpperCase()===t.toUpperCase());a&&i&&(e[a]=i)}this.currentDataList.unshift(e),this.newRows.push(e)},getPkColumnName(){const e=this.tableColumns.find(e=>["1",1,"Y",!0].includes(e.IS_PK));if(e)return e.COLUMN_NAME;const t=this.tableColumns.find(e=>"ID"===e.COLUMN_NAME.toUpperCase());return t?t.COLUMN_NAME:this.tableColumns.length>0?this.tableColumns[0].COLUMN_NAME:null},getCleanRowData(e){const t={};return this.tableColumns.forEach(i=>{t[i.COLUMN_NAME]=e[i.COLUMN_NAME]}),e.DB_INTERNAL_ID&&(t.DB_INTERNAL_ID=e.DB_INTERNAL_ID),t},async submitBatchChanges(){if(this.saving)return;this.saving=!0;const e=this.$loading({lock:!0,text:"正在保存中...",background:"rgba(0, 0, 0, 0.7)"});try{let t=0;for(const e of this.newRows){const i=this.getCleanRowData(e);delete i.DB_INTERNAL_ID;const a=await this.request("post",`/save?schema=${this.currentSchema}&tableName=${this.activeTable}`,i);if(200!==a.data.code)throw new Error(a.data.msg);t++}for(const i of Array.from(this.modifiedRows)){const a=this.currentDataList.find(e=>e.DB_INTERNAL_ID===i);if(!a)continue;const s=await this.request("post",`/save?schema=${this.currentSchema}&tableName=${this.activeTable}`,this.getCleanRowData(a));if(200!==s.data.code){if(503===s.data.code){this.conflictList=s.data.data,this.conflictType="edit";const t=this.getPkColumnName();return t&&this.originalDataMap[i]?this.conflictPkValue=this.originalDataMap[i][t]:this.conflictPkValue=a[t],this.conflictVisible=!0,e.close(),void(this.saving=!1)}throw new Error(s.data.msg)}t++}e.close(),t>0?(this.$message.success(`保存成功！共 ${t} 条`),this.loadData()):this.$message.info("没有检测到有效变更")}catch(t){e.close(),this.handleError(t,"保存失败")}finally{this.saving=!1}},handleDeleteRow(e,t){if(t.DB_INTERNAL_ID)this.$confirm("确定删除该行数据吗?","提示",{type:"warning"}).then(async()=>{const e=this.getPkColumnName(),i=e?t[e]:null,a=await this.request("delete","/delete",{schema:this.currentSchema,tableName:this.activeTable,internalId:t.DB_INTERNAL_ID,pkValue:i});if(200===a.data.code)this.$message.success("删除成功"),this.loadData();else{if(503!==a.data.code)throw new Error(a.data.msg);this.conflictList=a.data.data,this.conflictPkValue=i,this.conflictType="delete",this.conflictVisible=!0}}).catch(e=>{"cancel"!==e&&this.handleError({message:e.message||"删除失败"},"删除失败")});else{this.currentDataList.splice(e,1);const i=this.newRows.indexOf(t);i>-1&&this.newRows.splice(i,1)}},addCondition(){this.tableColumns.length>0&&this.conditions.push({field:this.tableColumns[0].COLUMN_NAME,operator:"=",value:""})},removeCondition(e){this.conditions.splice(e,1)},handleQuery(){this.currentPage=1,this.loadData()},resetFilters(){this.conditions=[],this.handleQuery()},applyAutoFilter(e){this.conditions=[{field:e.field,operator:"=",value:e.value}],this.$nextTick(()=>{this.handleQuery()})},resolveConflict(e){this.conflictVisible=!1;let t="";t="MISSING"===e.CNT?e.MY_VAL:this.conflictPkValue,this.$emit("open-table",{connId:this.connId,schema:this.currentSchema,tableName:e.TABLE_NAME,initViewMode:"data",filter:{field:e.COLUMN_NAME,value:t}})},async handleShowDDL(){try{const e=await this.request("get","/ddl",{schema:this.currentSchema,tableName:this.activeTable});let t=e.data.data||"";this.currentDDL=t.replace(/&quot;/g,'"').replace(/&apos;/g,"'").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&"),this.ddlVisible=!0}catch(e){this.handleError(e,"获取DDL失败")}},async handleDesignTable(){try{const t=await this.request("get","/columns",{schema:this.currentSchema,tableName:this.activeTable}),i=t.data.data;this.originalColumns=JSON.parse(JSON.stringify(i.map(e=>({...e,DATA_LENGTH:e.DATA_LENGTH?String(e.DATA_LENGTH):"",COMMENTS:e.COMMENTS||"",DATA_DEFAULT:e.DATA_DEFAULT||"",IS_PK:["1",1,"Y","y","true",!0].includes(e.IS_PK)})))),this.designColumns=JSON.parse(JSON.stringify(this.originalColumns)).map(e=>({...e,_status:"original",_originalName:e.COLUMN_NAME}));try{const e=await this.request("get","/indexes",{schema:this.currentSchema,tableName:this.activeTable});200===e.data.code&&(this.designIndexes=e.data.data.map(e=>({...e,_status:"original",COLUMNS:e.COLUMNS.split(",")})))}catch(e){this.designIndexes=[]}try{const e=await this.request("get","/foreign-keys",{schema:this.currentSchema,tableName:this.activeTable});if(200===e.data.code){this.designForeignKeys=e.data.data.map(e=>({...e,_status:"original"}));const t=[...new Set(this.designForeignKeys.map(e=>e.R_TABLE_NAME).filter(e=>e))];t.forEach(e=>this.loadRefColumns(e))}}catch(e){this.designForeignKeys=[]}const a=await this.request("get","/tables",{schema:this.currentSchema});this.allTableNames=(a.data.data||[]).map(e=>e.TABLE_NAME),this.deleteColumnList=[],this.deleteIndexList=[],this.deleteFkList=[],this.designActiveTab="columns",this.designVisible=!0}catch(e){this.handleError(e,"加载设计器失败")}},async loadRefColumns(e){if(e&&!this.refColumnsCache[e])try{const t=await this.request("get","/columns",{schema:this.currentSchema,tableName:e});this.$set(this.refColumnsCache,e,t.data.data||[])}catch(t){console.error("加载引用表列失败",t)}},handleRefTableChange(e){e.R_COLUMN_NAME="",e.R_TABLE_NAME&&this.loadRefColumns(e.R_TABLE_NAME)},isDiff(e,t){const i=null===e||void 0===e?"":String(e).trim(),a=null===t||void 0===t?"":String(t).trim();return i!==a},addDesignColumn(){this.designColumns.push({COLUMN_NAME:"NEW_COL",DATA_TYPE:"VARCHAR2",DATA_LENGTH:"50",NULLABLE:"Y",IS_PK:!1,_status:"new"})},removeDesignColumn(e,t){"new"!==t._status&&this.deleteColumnList.push(t.COLUMN_NAME),this.designColumns.splice(e,1)},markModified(e){if("new"===e._status)return;const t=this.originalColumns.find(t=>t.COLUMN_NAME===e._originalName);if(!t)return;const i=this.isDiff(e.COLUMN_NAME,t.COLUMN_NAME)||this.isDiff(e.DATA_TYPE,t.DATA_TYPE)||this.isDiff(e.DATA_LENGTH,t.DATA_LENGTH)||e.IS_PK!==t.IS_PK||this.isDiff(e.NULLABLE,t.NULLABLE)||this.isDiff(e.DATA_DEFAULT,t.DATA_DEFAULT)||this.isDiff(e.COMMENTS,t.COMMENTS);e._status=i?"modified":"original"},handlePkChange(e){if(e.IS_PK){const t=this.designColumns.some(t=>t!==e&&t.IS_PK);if(t)return this.$message.warning("一张表只能有一个主键，请先取消原主键再设置新主键。"),void this.$nextTick(()=>{e.IS_PK=!1})}this.markModified(e)},addDesignIndex(){this.designIndexes.push({INDEX_NAME:"",INDEX_TYPE:"NORMAL",COLUMNS:[],_status:"new"})},removeDesignIndex(e,t){"new"!==t._status&&this.deleteIndexList.push(t.INDEX_NAME),this.designIndexes.splice(e,1)},addDesignFk(){this.designForeignKeys.push({CONSTRAINT_NAME:"",COLUMN_NAME:"",R_TABLE_NAME:"",R_COLUMN_NAME:"",DELETE_RULE:"NO ACTION",_status:"new"})},removeDesignFk(e,t){"new"!==t._status&&this.deleteFkList.push(t.CONSTRAINT_NAME),this.designForeignKeys.splice(e,1)},generateAndRunAlter(){var e,t;let i=[];const a=this.currentSchema,s=this.activeTable,n=/^[a-zA-Z0-9_]+$/;for(const r of this.designColumns)if(!n.test(r.COLUMN_NAME))return void this.$message.error(`列名 "${r.COLUMN_NAME}" 不合法，仅支持字母、数字和下划线。`);this.deleteColumnList.forEach(e=>i.push(`ALTER TABLE "${a}"."${s}" DROP COLUMN "${e}";`)),this.designColumns.filter(e=>"modified"===e._status).forEach(e=>{const t=this.originalColumns.find(t=>t.COLUMN_NAME===e._originalName);if(!t)return;this.isDiff(e.COLUMN_NAME,e._originalName)&&i.push(`ALTER TABLE "${a}"."${s}" RENAME COLUMN "${e._originalName}" TO "${e.COLUMN_NAME}";`);let n=e.DATA_TYPE;e.DATA_LENGTH&&!["NUMBER","DATE","TIMESTAMP","CLOB","BLOB"].includes(e.DATA_TYPE)&&(n+=`(${e.DATA_LENGTH})`);let l=`ALTER TABLE "${a}"."${s}" MODIFY "${e.COLUMN_NAME}" ${n}`;e.DATA_DEFAULT&&this.isDiff(e.DATA_DEFAULT,t.DATA_DEFAULT)&&(l+=" DEFAULT "+e.DATA_DEFAULT),this.isDiff(e.NULLABLE,t.NULLABLE)&&(l+="N"===e.NULLABLE?" NOT NULL":" NULL");const o=this.isDiff(e.DATA_TYPE,t.DATA_TYPE)||this.isDiff(e.DATA_LENGTH,t.DATA_LENGTH)||this.isDiff(e.NULLABLE,t.NULLABLE)||this.isDiff(e.DATA_DEFAULT,t.DATA_DEFAULT);o&&i.push(l+";"),this.isDiff(e.COMMENTS,t.COMMENTS)&&i.push(`COMMENT ON COLUMN "${a}"."${s}"."${e.COLUMN_NAME}" IS '${e.COMMENTS}';`)});const l=null===(e=this.originalColumns.find(e=>["1",1,"Y",!0].includes(e.IS_PK)))||void 0===e?void 0:e.COLUMN_NAME,o=null===(t=this.designColumns.find(e=>e.IS_PK))||void 0===t?void 0:t.COLUMN_NAME;if(l!==o&&(l&&i.push(`ALTER TABLE "${a}"."${s}" DROP PRIMARY KEY;`),o&&i.push(`ALTER TABLE "${a}"."${s}" ADD PRIMARY KEY ("${o}");`)),this.designColumns.filter(e=>"new"===e._status).forEach(e=>{let t=`ALTER TABLE "${a}"."${s}" ADD "${e.COLUMN_NAME}" ${e.DATA_TYPE}`;e.DATA_LENGTH&&!["NUMBER","DATE","TIMESTAMP","CLOB","BLOB"].includes(e.DATA_TYPE)&&(t+=`(${e.DATA_LENGTH})`),e.DATA_DEFAULT&&(t+=" DEFAULT "+e.DATA_DEFAULT),"N"===e.NULLABLE&&(t+=" NOT NULL"),i.push(t+";"),e.COMMENTS&&i.push(`COMMENT ON COLUMN "${a}"."${s}"."${e.COLUMN_NAME}" IS '${e.COMMENTS}';`)}),this.deleteIndexList.forEach(e=>i.push(`DROP INDEX "${a}"."${e}";`)),this.designIndexes.filter(e=>"new"===e._status).forEach(e=>{if(!e.INDEX_NAME||0===e.COLUMNS.length)return;const t=e.COLUMNS.map(e=>`"${e}"`).join(","),n="UNIQUE"===e.INDEX_TYPE?"UNIQUE":"BITMAP"===e.INDEX_TYPE?"BITMAP":"";i.push(`CREATE ${n} INDEX "${e.INDEX_NAME}" ON "${a}"."${s}" (${t});`)}),this.deleteFkList.forEach(e=>i.push(`ALTER TABLE "${a}"."${s}" DROP CONSTRAINT "${e}";`)),this.designForeignKeys.filter(e=>"new"===e._status).forEach(e=>{if(!e.CONSTRAINT_NAME||!e.COLUMN_NAME||!e.R_TABLE_NAME||!e.R_COLUMN_NAME)return;let t=`ALTER TABLE "${a}"."${s}" ADD CONSTRAINT "${e.CONSTRAINT_NAME}" FOREIGN KEY ("${e.COLUMN_NAME}") REFERENCES "${a}"."${e.R_TABLE_NAME}"("${e.R_COLUMN_NAME}")`;"CASCADE"===e.DELETE_RULE?t+=" ON DELETE CASCADE":"SET NULL"===e.DELETE_RULE&&(t+=" ON DELETE SET NULL"),i.push(t+";")}),!i.length)return this.$message.info("无结构变更");this.generatedSql=i.join("\n"),this.sqlConfirmVisible=!0},async executeAlter(){this.altering=!0;try{const e=this.generatedSql.split(";").map(e=>e.trim()).filter(e=>e),t=await this.request("post","/execute/batch",{sqls:e});if(200!==t.data.code)throw new Error(t.data.msg);this.$message.success("修改成功"),this.sqlConfirmVisible=!1,this.designVisible=!1,"relation"===this.viewMode?this.loadRelations():this.loadData()}catch(e){this.handleError(e,"表结构变更失败")}finally{this.altering=!1}},indexMethod(e){return(this.currentPage-1)*this.pageSize+e+1},handleSortChange({prop:e,order:t}){if(!e)return;const i=[...this.currentDataList];i.sort((i,a)=>{let s=i[e],n=a[e];return null==s&&(s=""),null==n&&(n=""),s>n?"ascending"===t?1:-1:s<n?"ascending"===t?-1:1:0}),this.currentDataList=i},handleSizeChange(e){this.pageSize=e,this.currentPage=1,this.loadData()},handleCurrentChange(e){this.currentPage=e,this.loadData()},async runSql(){const e=await this.request("post","/execute",{sql:this.customSql});200===e.data.code&&(this.sqlResult=e.data.data)},destroyGraph(){this.graphInstance&&(this.graphInstance.destroy(),this.graphInstance=null);const e=this.$refs.relationCanvas;e&&(e.innerHTML="")},handleShowAllChange(e){e?this.graphNodeIds.length>0&&(this.expandedTableList=[...this.graphNodeIds]):this.expandedTableList=[],this.loadRelations()},async loadRelations(){this.destroyGraph();try{const e=await this.request("get","/er-data",{schema:this.currentSchema,tableName:this.activeTable,showAll:this.showAllColumns,expandedTables:this.expandedTableList.join(",")});"relation"===this.viewMode&&(this.graphNodeIds=e.data.data.nodes.map(e=>e.id),this.checkAutoExpandState(),this.$nextTick(()=>this.initGraph(e.data.data)))}catch(e){}},checkAutoExpandState(){if(this.graphNodeIds.length>0){const e=this.graphNodeIds.every(e=>this.expandedTableList.includes(e));this.showAllColumns!==e&&(this.showAllColumns=e)}},handleGraphZoom(e){if(!this.graphInstance)return;const t=this.graphInstance.getZoom();this.graphInstance.zoomTo(t*e,{x:this.$refs.relationCanvas.offsetWidth/2,y:this.$refs.relationCanvas.offsetHeight/2})},handleGraphFit(){this.graphInstance&&this.graphInstance.fitView()},initGraph(e){const t=this.$refs.relationCanvas;if(!t)return;t.innerHTML="";const i=e.nodes.length,a=i>5?150:100;this.graphInstance=new m["a"].Graph({container:t,width:t.offsetWidth,height:t.offsetHeight,fitView:!0,fitViewPadding:40,renderer:"canvas",layout:{type:"dagre",rankdir:"LR",nodesep:50,ranksep:a},defaultNode:{type:"db-table",anchorPoints:[[0,.5],[1,.5]]},defaultEdge:{type:"cubic-horizontal",style:{stroke:"#A3B1BF",lineWidth:2,endArrow:!0},labelCfg:{autoRotate:!0,style:{fontSize:10,fill:"#aaa"}}},modes:{default:["drag-canvas","zoom-canvas","drag-node"]}}),this.graphInstance.data(JSON.parse(JSON.stringify(e))),this.graphInstance.render(),this.graphInstance.on("node:click",e=>{const t=e.target.get("name"),i=e.item.getModel().id;if("expand-text"===t)this.expandedTableList.includes(i)||(this.expandedTableList.push(i),this.loadRelations());else if("collapse-text"===t){const e=this.expandedTableList.indexOf(i);e>-1&&(this.expandedTableList.splice(e,1),this.showAllColumns=!1,this.loadRelations())}}),this.graphInstance.on("node:dblclick",e=>{const t=e.item.getModel().label;t!==this.activeTable&&this.$emit("open-table",{connId:this.connId,schema:this.currentSchema,tableName:t,initViewMode:"data"})})}},beforeDestroy(){this.destroyGraph()}},A=y,T=(i("8870"),Object(v["a"])(A,f,p,!1,null,"774abb4e",null)),M=T.exports;const L="DMDB_CONNECTIONS";var k={name:"MultiWindowLayout",components:{TableDetail:M},data(){return{filterText:"",treeData:[],defaultProps:{label:"label",isLeaf:"leaf"},tabs:[],activeTab:"",globalViewMode:"data",isRefreshing:!1,dialogVisible:!1,isEditMode:!1,currentEditNode:null,dialogTitle:"新建连接",connecting:!1,testing:!1,connForm:{name:"本地达梦",host:"localhost",port:"5236",user:"SYSDBA",password:""},submitting:!1,currentNodeData:null,currentNodeRef:null,createTableVisible:!1,tableForm:{tableName:"",columns:[{name:"ID",type:"INTEGER",length:"",pk:!0,notNull:!0}]},createViewVisible:!1,viewForm:{name:"",sql:""},createTriggerVisible:!1,triggerSql:""}},watch:{filterText(e){this.$refs.tree.filter(e)}},created(){this.restoreConnections()},methods:{filterNode(e,t){return!e||-1!==t.label.toLowerCase().indexOf(e.toLowerCase())},getIcon(e){return"root"===e?"el-icon-connection":"folder_schema"===e?"el-icon-files":"schema"===e?"el-icon-folder-opened":e&&e.startsWith("folder_")?"el-icon-folder":"table"===e?"el-icon-document-copy":"view"===e?"el-icon-view":"trigger"===e?"el-icon-s-operation":"el-icon-document"},handleViewModeChange(e){this.globalViewMode=e},handleRefresh(){this.isRefreshing=!0,this.treeData=[],this.$nextTick(()=>{this.restoreConnections(),setTimeout(()=>{this.isRefreshing=!1,this.$message.success("列表已刷新")},500)})},restoreConnections(){const e=localStorage.getItem(L);if(e)try{const t=JSON.parse(e);this.treeData=t.map(e=>({...e,loading:!0,connStatus:"connecting",errorMsg:""})),this.treeData.forEach(async e=>{try{const t=await u.post("/connection/connect",{id:e.id,...e.config}),i=this.treeData.find(t=>t.id===e.id);i&&(200===t.data.code?(this.$set(i,"loading",!1),this.$set(i,"connStatus","success"),this.$set(i,"errorMsg","")):(this.$set(i,"loading",!1),this.$set(i,"connStatus","fail"),this.$set(i,"errorMsg",t.data.msg)))}catch(i){var t;const a=(null===(t=i.response)||void 0===t||null===(t=t.data)||void 0===t?void 0:t.msg)||i.message||"连接失败",s=this.treeData.find(t=>t.id===e.id);s&&(this.$set(s,"loading",!1),this.$set(s,"connStatus","fail"),this.$set(s,"errorMsg",a))}})}catch(t){console.error("Restore failed:",t)}},saveConnections(){const e=this.treeData.map(e=>({id:e.id,label:e.label,type:"root",leaf:!1,config:e.config}));localStorage.setItem(L,JSON.stringify(e))},async loadNode(e,t){if(0===e.level)return t(this.treeData);const i=e.data;if(i.loading)return this.$message.warning("正在尝试恢复连接，请稍候..."),t([]);if("root"===i.type&&"fail"===i.connStatus)return this.$message.error(i.errorMsg||"连接不可用"),t([]);if("root"===i.type)t([{label:"模式",type:"folder_schema",connId:i.id,connName:i.label,leaf:!1}]);else if("folder_schema"===i.type)try{const e=await u.get("/db/schemas",{headers:{"Conn-Id":i.connId}}),a=(e.data.data||[]).sort((e,t)=>e.localeCompare(t)),s=a.map(e=>({label:e,type:"schema",connId:i.connId,connName:i.connName,leaf:!1}));t(s)}catch(a){t([])}else if("schema"===i.type)t([{label:"数据表",type:"folder_table",connId:i.connId,connName:i.connName,schema:i.label,leaf:!1},{label:"视图",type:"folder_view",connId:i.connId,connName:i.connName,schema:i.label,leaf:!1},{label:"触发器",type:"folder_trigger",connId:i.connId,connName:i.connName,schema:i.label,leaf:!1}]);else if("folder_table"===i.type)try{const e=await u.get("/db/tables",{params:{schema:i.schema},headers:{"Conn-Id":i.connId}}),a=e.data.data.map(e=>({label:e.TABLE_NAME,comment:e.COMMENTS,type:"table",connId:i.connId,connName:i.connName,schema:i.schema,leaf:!0}));t(a)}catch(a){t([])}else if("folder_view"===i.type)try{const e=await u.get("/db/views",{params:{schema:i.schema},headers:{"Conn-Id":i.connId}}),a=e.data.data.map(e=>({label:e.VIEW_NAME,type:"view",connId:i.connId,connName:i.connName,schema:i.schema,leaf:!0}));t(a)}catch(a){t([])}else if("folder_trigger"===i.type)try{const e=await u.get("/db/triggers",{params:{schema:i.schema},headers:{"Conn-Id":i.connId}}),a=e.data.data.map(e=>({label:e.TRIGGER_NAME,status:e.STATUS,type:"trigger",connId:i.connId,connName:i.connName,schema:i.schema,leaf:!0}));t(a)}catch(a){t([])}else t([])},openAddDialog(){this.isEditMode=!1,this.dialogTitle="新建连接",this.connForm={name:"本地达梦",host:"localhost",port:"5236",user:"SYSDBA",password:""},this.dialogVisible=!0},openEditDialog(e){this.isEditMode=!0,this.currentEditNode=e,this.dialogTitle="编辑连接",this.connForm=JSON.parse(JSON.stringify(e.config||{})),e.config||(this.connForm.name=e.label),this.dialogVisible=!0},validateConnName(e){if(!e||!e.trim())return!1;const t=this.treeData.find(t=>this.isEditMode&&this.currentEditNode?t.label===e&&t.id!==this.currentEditNode.id:t.label===e);return!t},async testConnection(){this.testing=!0;try{const e={...this.connForm};this.isEditMode&&this.currentEditNode&&(e.id=this.currentEditNode.id);const t=await u.post("/connection/connect",e);200===t.data.code?this.$message.success("连接成功！"):this.$message.error("连接失败: "+t.data.msg)}catch(e){this.$message.error("连接异常，请检查网络")}finally{this.testing=!1}},async submitConnection(){if(this.connForm.name)if(this.validateConnName(this.connForm.name)){this.connecting=!0;try{if(this.isEditMode){const e=this.currentEditNode.id,t=await u.post("/connection/connect",{id:e,...this.connForm});if(200!==t.data.code)return void this.$message.error(t.data.msg||"连接失败，无法保存配置");const i=this.treeData.find(t=>t.id===e);i&&(this.$set(i,"label",this.connForm.name),this.$set(i,"config",JSON.parse(JSON.stringify(this.connForm))),this.$set(i,"connStatus","success"),this.$set(i,"errorMsg",""),this.$set(i,"loading",!1)),this.saveConnections(),this.$message.success("更新成功"),this.dialogVisible=!1}else{const e=await u.post("/connection/connect",this.connForm);if(200===e.data.code){const t=e.data.data,i=this.treeData.some(e=>e.id===t);i||(this.treeData.push({id:t,label:this.connForm.name,type:"root",leaf:!1,config:JSON.parse(JSON.stringify(this.connForm)),connStatus:"success",errorMsg:"",loading:!1}),this.saveConnections()),this.dialogVisible=!1,this.$message.success("创建成功")}else this.$message.error("创建失败: "+e.data.msg)}}catch(e){this.$message.error("连接失败，无法保存配置")}finally{this.connecting=!1}}else this.$message.warning("连接名称已存在，请使用其他名称");else this.$message.warning("请输入连接名称")},handleDeleteConn(e,t){this.$confirm(`确定删除连接【${t.label}】吗?`,"提示",{type:"warning"}).then(async()=>{try{await u.delete("/connection/delete",{headers:{"Conn-Id":t.id}})}catch(e){}this.treeData=this.treeData.filter(e=>e.id!==t.id),this.tabs=this.tabs.filter(e=>e.connId!==t.id),0===this.tabs.length?this.activeTab="":this.tabs.find(e=>e.key===this.activeTab)||(this.activeTab=this.tabs[this.tabs.length-1].key),this.saveConnections(),this.$message.success("删除成功")}).catch(()=>{})},handleNodeClick(e){"table"===e.type||"view"===e.type?this.openTab(e.connId,e.connName,e.schema,e.label,e.type):"trigger"===e.type&&this.$message.info(`触发器 [${e.label}]：${"ENABLED"===e.status?"已启用":"已禁用"} (暂不支持编辑)`)},handleOpenTable(e){let t="Unknown";const i=this.tabs.find(t=>t.connId===e.connId);if(i)t=i.connName;else{const i=this.treeData.find(t=>t.id===e.connId);i&&(t=i.label)}const a=e.type||"table";this.openTab(e.connId,t,e.schema,e.tableName,a,e.filter,e.initViewMode)},openTab(e,t,i,a,s="table",n=null,l=null){const o=`${e}-${i}-${a}`,r=this.tabs.findIndex(e=>e.key===o),c=l||this.globalViewMode||"data";if(r>-1){this.activeTab=o;const e=this.tabs[r],t=n||l&&e.initViewMode!==l;if(t){const t={...e,filter:n||e.filter,initViewMode:c};this.$set(this.tabs,r,t)}}else this.tabs.push({key:o,title:`${t} - ${a}`,connId:e,connName:t,schema:i,tableName:a,tableType:s,filter:n,initViewMode:c}),this.activeTab=o},removeTab(e){const t=this.tabs;let i=this.activeTab;i===e&&t.forEach((a,s)=>{if(a.key===e){const e=t[s+1]||t[s-1];e&&(i=e.key)}}),this.activeTab=i,this.tabs=t.filter(t=>t.key!==e)},openCreateDialog(e,t){this.currentNodeData=t,this.currentNodeRef=e,"folder_table"===t.type?(this.tableForm={tableName:"",columns:[{name:"ID",type:"INTEGER",length:"",pk:!0,notNull:!0}]},this.createTableVisible=!0):"folder_view"===t.type?(this.viewForm={name:"",sql:""},this.createViewVisible=!0):"folder_trigger"===t.type&&(this.triggerSql=`CREATE OR REPLACE TRIGGER "${t.schema}"."TRG_NAME"\nBEFORE INSERT ON "${t.schema}"."TABLE_NAME"\nFOR EACH ROW\nBEGIN\n\t-- logic here\nEND;`,this.createTriggerVisible=!0)},handleDeleteObject(e,t){const i={table:"表",view:"视图",trigger:"触发器"},a=i[t.type];this.$confirm(`确定删除${a}【${t.label}】吗？此操作不可恢复！`,"危险操作",{type:"warning",confirmButtonClass:"el-button--danger"}).then(async()=>{let i="";const a=`"${t.schema}"."${t.label}"`;"table"===t.type?i="DROP TABLE "+a:"view"===t.type?i="DROP VIEW "+a:"trigger"===t.type&&(i="DROP TRIGGER "+a);try{const a=await u.post("/db/execute",{sql:i},{headers:{"Conn-Id":t.connId}});if(200===a.data.code){this.$message.success("删除成功");const i=`${t.connId}-${t.schema}-${t.label}`;this.removeTab(i),e.parent&&(e.parent.loaded=!1,e.parent.expand())}else this.$message.error(a.data.msg)}catch(s){this.$message.error("请求失败")}}).catch(()=>{})},addTableColumn(){this.tableForm.columns.push({name:"",type:"VARCHAR",length:"50",pk:!1,notNull:!1})},removeTableColumn(e){this.tableForm.columns.splice(e,1)},async executeDDL(e){this.submitting=!0;try{const t=await u.post("/db/execute",{sql:e},{headers:{"Conn-Id":this.currentNodeData.connId}});return 200===t.data.code?(this.$message.success("创建成功"),this.currentNodeRef.loaded=!1,this.currentNodeRef.expand(),!0):(this.$message.error(t.data.msg),!1)}catch(t){return this.$message.error("请求失败"),!1}finally{this.submitting=!1}},async submitCreateTable(){if(!this.tableForm.tableName)return this.$message.warning("请输入表名");const e=this.currentNodeData.schema,t=`"${e}"."${this.tableForm.tableName}"`;let i=this.tableForm.columns.map(e=>{let t=`"${e.name}" ${e.type}`;return e.length&&!["INTEGER","DATE","TIMESTAMP","TEXT"].includes(e.type)&&(t+=`(${e.length})`),e.notNull&&(t+=" NOT NULL"),e.pk&&(t+=" PRIMARY KEY"),t}).join(",\n  ");const a=`CREATE TABLE ${t} (\n  ${i}\n);`;await this.executeDDL(a)&&(this.createTableVisible=!1)},async submitCreateView(){if(!this.viewForm.name||!this.viewForm.sql)return this.$message.warning("请填写完整");const e=this.currentNodeData.schema,t=`CREATE OR REPLACE VIEW "${e}"."${this.viewForm.name}" AS\n${this.viewForm.sql}`;await this.executeDDL(t)&&(this.createViewVisible=!1)},async submitCreateTrigger(){this.triggerSql&&await this.executeDDL(this.triggerSql)&&(this.createTriggerVisible=!1)}}},S=k,D=(i("f41d"),Object(v["a"])(S,r,c,!1,null,"ac283970",null)),x=D.exports,I={name:"App",components:{MultiWindowLayout:x}},O=I,$=(i("d3a5"),Object(v["a"])(O,l,o,!1,null,null,null)),R=$.exports;a["default"].use(n.a,{size:"small"}),a["default"].config.productionTip=!1,new a["default"]({render:e=>e(R)}).$mount("#app")},7428:function(e,t,i){},8845:function(e,t,i){},8870:function(e,t,i){"use strict";i("8845")},aea4:function(e,t,i){},d3a5:function(e,t,i){"use strict";i("7428")},f41d:function(e,t,i){"use strict";i("aea4")}});
//# sourceMappingURL=app.3a9f29ad.js.map
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.dmdb.mapper.MetadataMapper">

    <select id="getAllSchemas" resultType="string">
        SELECT USERNAME FROM DBA_USERS ORDER BY USERNAME
    </select>

    <select id="getTablesBySchema" resultType="map">
        SELECT TABLE_NAME, COMMENTS
        FROM ALL_TAB_COMMENTS
        WHERE OWNER = #{schema}
          AND TABLE_TYPE = 'TABLE'
          AND TABLE_NAME NOT LIKE 'SREF_CON_TAB%'
          AND TABLE_NAME NOT LIKE 'BIN$%'
    </select>

    <select id="getColumns" resultType="map">
        SELECT
            T.COLUMN_NAME, T.DATA_TYPE, T.DATA_LENGTH, T.DATA_PRECISION, T.DATA_SCALE, T.NULLABLE, C.COMMENTS,
            (SELECT COUNT(1) FROM ALL_CONSTRAINTS AC JOIN ALL_CONS_COLUMNS ACC ON AC.CONSTRAINT_NAME = ACC.CONSTRAINT_NAME WHERE AC.CONSTRAINT_TYPE = 'P' AND AC.OWNER = T.OWNER AND AC.TABLE_NAME = T.TABLE_NAME AND ACC.COLUMN_NAME = T.COLUMN_NAME) AS IS_PK,
            T.DATA_DEFAULT
        FROM ALL_TAB_COLUMNS T
        LEFT JOIN ALL_COL_COMMENTS C ON T.OWNER = C.OWNER AND T.TABLE_NAME = C.TABLE_NAME AND T.COLUMN_NAME = C.COLUMN_NAME
        WHERE T.OWNER = #{schema} AND T.TABLE_NAME = #{tableName}
        ORDER BY T.COLUMN_ID
    </select>

    <select id="getViews" resultType="map">
        SELECT VIEW_NAME FROM ALL_VIEWS WHERE OWNER = #{schema}
    </select>

    <select id="getTriggers" resultType="map">
        SELECT TRIGGER_NAME, STATUS FROM ALL_TRIGGERS WHERE OWNER = #{schema}
    </select>

    <select id="getDDL" resultType="java.lang.Object">
        SELECT DBMS_METADATA.GET_DDL(#{type}, #{tableName}, #{schema}) FROM DUAL
    </select>

    <select id="getTableRelations" resultType="map">
        SELECT A.TABLE_NAME AS SOURCE_TABLE, A.COLUMN_NAME AS SOURCE_COL, C_PK.TABLE_NAME AS TARGET_TABLE, RA.COLUMN_NAME AS TARGET_COL
        FROM ALL_CONS_COLUMNS A JOIN ALL_CONSTRAINTS C ON A.CONSTRAINT_NAME = C.CONSTRAINT_NAME JOIN ALL_CONSTRAINTS C_PK ON C.R_CONSTRAINT_NAME = C_PK.CONSTRAINT_NAME JOIN ALL_CONS_COLUMNS RA ON C.R_CONSTRAINT_NAME = RA.CONSTRAINT_NAME
        WHERE C.CONSTRAINT_TYPE = 'R' AND (A.OWNER = #{schema} AND A.TABLE_NAME = #{tableName} OR C_PK.OWNER = #{schema} AND C_PK.TABLE_NAME = #{tableName})
    </select>

    <select id="getColumnsForTables" resultType="map">
        SELECT
        T.TABLE_NAME,
        T.COLUMN_NAME,
        T.DATA_TYPE,
        C.COMMENTS,
        0 as IS_PK
        FROM ALL_TAB_COLUMNS T
        LEFT JOIN ALL_COL_COMMENTS C ON T.OWNER = C.OWNER AND T.TABLE_NAME = C.TABLE_NAME AND T.COLUMN_NAME = C.COLUMN_NAME
        WHERE T.OWNER = #{schema}
        AND T.TABLE_NAME IN <foreach collection="tableList" item="t" open="(" separator="," close=")">#{t}</foreach>
        ORDER BY T.TABLE_NAME, T.COLUMN_ID
    </select>

    <select id="getTableComments" resultType="map">
        SELECT TABLE_NAME, COMMENTS FROM ALL_TAB_COMMENTS WHERE OWNER = #{schema} AND TABLE_NAME IN <foreach collection="tableList" item="t" open="(" separator="," close=")">#{t}</foreach>
    </select>

    <select id="getAllChildTables" resultType="map">
        SELECT A.TABLE_NAME, A.COLUMN_NAME FROM ALL_CONS_COLUMNS A JOIN ALL_CONSTRAINTS C ON A.CONSTRAINT_NAME = C.CONSTRAINT_NAME AND A.OWNER = C.OWNER JOIN ALL_CONSTRAINTS C_PK ON C.R_CONSTRAINT_NAME = C_PK.CONSTRAINT_NAME AND C.R_OWNER = C_PK.OWNER WHERE C.CONSTRAINT_TYPE = 'R' AND C_PK.OWNER = #{schema} AND C_PK.TABLE_NAME = #{tableName}
    </select>

    <select id="getPkColumnsForTables" resultType="map">
        SELECT C.TABLE_NAME, CC.COLUMN_NAME
        FROM ALL_CONSTRAINTS C
        JOIN ALL_CONS_COLUMNS CC ON C.CONSTRAINT_NAME = CC.CONSTRAINT_NAME AND C.OWNER = CC.OWNER
        WHERE C.OWNER = #{schema}
        AND C.CONSTRAINT_TYPE = 'P'
        AND C.TABLE_NAME IN <foreach collection="tableList" item="t" open="(" separator="," close=")">#{t}</foreach>
    </select>

    <select id="getIndexes" resultType="map">
        SELECT
            I.INDEX_NAME,
            I.INDEX_TYPE,
            I.UNIQUENESS,
            NVL((SELECT LISTAGG(C.COLUMN_NAME, ',') WITHIN GROUP(ORDER BY C.COLUMN_POSITION)
                 FROM ALL_IND_COLUMNS C
                 WHERE C.INDEX_OWNER = I.OWNER AND C.INDEX_NAME = I.INDEX_NAME), '') AS COLUMNS
        FROM ALL_INDEXES I
        WHERE I.TABLE_OWNER = #{schema}
          AND I.TABLE_NAME = #{tableName}
          AND I.GENERATED = 'N'
          AND I.INDEX_TYPE NOT LIKE 'LOB%'
          AND NOT EXISTS (
              SELECT 1
              FROM ALL_CONSTRAINTS C
              WHERE C.OWNER = I.OWNER
                AND C.CONSTRAINT_TYPE = 'P'
                AND C.INDEX_NAME = I.INDEX_NAME
          )
    </select>

    <select id="getForeignKeys" resultType="map">
        SELECT C.CONSTRAINT_NAME, A.COLUMN_NAME, C_PK.TABLE_NAME AS R_TABLE_NAME, RA.COLUMN_NAME AS R_COLUMN_NAME, C.DELETE_RULE FROM ALL_CONSTRAINTS C JOIN ALL_CONS_COLUMNS A ON C.CONSTRAINT_NAME = A.CONSTRAINT_NAME JOIN ALL_CONSTRAINTS C_PK ON C.R_CONSTRAINT_NAME = C_PK.CONSTRAINT_NAME JOIN ALL_CONS_COLUMNS RA ON C.R_CONSTRAINT_NAME = RA.CONSTRAINT_NAME WHERE C.CONSTRAINT_TYPE = 'R' AND C.OWNER = #{schema} AND C.TABLE_NAME = #{tableName}
    </select>

    <select id="getPkColumn" resultType="string">
        SELECT ACC.COLUMN_NAME FROM ALL_CONSTRAINTS AC JOIN ALL_CONS_COLUMNS ACC ON AC.CONSTRAINT_NAME = ACC.CONSTRAINT_NAME WHERE AC.CONSTRAINT_TYPE = 'P' AND AC.OWNER = #{schema} AND AC.TABLE_NAME = #{tableName} AND ROWNUM = 1
    </select>

</mapper>